/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
 **/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");angular.module("opentok",[]).constant("TB",window.TB).provider("OTConfig",function(){var e;return{setKey:function(n){e=n},$get:function(){return{apiKey:e}}}}).factory("OTSession",["TB","$rootScope","$q","OTConfig","$log","_",function(e,n,i,s,o,t){if(!s.apiKey)throw new Error("You need to specify api key");var r={streams:[],connections:[],publishers:[],subscribers:[],ui:{hasAudio:!0,hasVideo:!0},init:function(t,u){return this.session=e.initSession(s.apiKey,t),r.session.on({sessionConnected:function(e){o.info("sessionConnected",e),r.publishers.forEach(function(e){r.session.publish(e)})},streamCreated:function(e){o.info("streamCreated",e),n.$apply(function(){r.streams.push(e.stream)})},streamDestroyed:function(e){o.info("streamDestroyed",e),n.$apply(function(){r.streams.splice(r.streams.indexOf(e.stream),1)})},sessionDisconnected:function(e){o.info("sessionDisconnected",e),n.$apply(function(){r.streams.splice(0,r.streams.length),r.resetPublishers()})},connectionCreated:function(e){o.info("connectionCreated",e),n.$apply(function(){r.connections.push(e.connection)})},connectionDestroyed:function(e){o.info("connectionDestroyed",e),n.$apply(function(){r.connections.splice(r.connections.indexOf(e.connection),1)})}}),r.trigger("init"),i(function(e,n){r.session.connect(u,function(i){return i?n(i):void e(r.session)})})},initPublisher:function(n,i){return e.initPublisher(s.apiKey,n,i)},isSessionConnected:function(){return this.session&&(this.session.connected||this.session.isConnected&&this.session.isConnected())},listen:function(e,n){Object.keys(e).forEach(function(i){r.session.on(i,function(s){e[i].call(n,s)})})},togglePublishersAudio:function(e){r.ui.hasAudio="boolean"==typeof e?e:!r.ui.hasAudio,r.publishers.forEach(function(e){e.publishAudio(r.ui.hasAudio)})},togglePublishersVideo:function(e){r.ui.hasVideo="boolean"==typeof e?e:!r.ui.hasVideo,r.publishers.forEach(function(e){e.publishVideo(r.ui.hasVideo)})},resetPublishers:function(){r.togglePublishersAudio(!0),r.togglePublishersVideo(!0)},getUniqueStreams:function(e){var n=t.groupBy(r.streams,function(e){return e.connection.id});return Object.keys(n).map(function(i){var s=n[i];return 1===s.length?s[0]:t.find(s,{videoType:e})})},disconnect:function(){r.isSessionConnected()&&(r.publishers.forEach(function(e){r.session.unpublish(e)}),r.session.disconnect(),r.session=null)}};return e.$.eventing(r),r}]).factory("OTDirectivesHelpers",["_",function(e){return{volumeLevels:[{level:0,name:"volume-low"},{level:.3,name:"volume-medium"},{level:.85,name:"volume-high"}],getVolumeLevelChanges:function(){var e=null;return function(n){e=null===e||e<=n.audioLevel?n.audioLevel:.7*e+.3*n.audioLevel;var i=Math.log(e)/Math.LN10/1.5+1;return Math.min(Math.max(i,0),1)}},setVolumeLevelChanges:function(n,i){var s=this,o=this.volumeLevels.map(function(e){return e.name}).join(" ");n.removeClass(o);var t,r=this.getVolumeLevelChanges(),u=0,c=0;return function(l){if(u+=r(l),c++,30===c){var a=u/c;u=c=0;var f=e.findLast(s.volumeLevels,function(e){return a>=e.level}).name;i&&i(f),t!==f&&(t=f,n.removeClass(o),n.addClass(f))}}}}}]).directive("otLayout",["$window","$parse","TB","OTSession",function(e,n,i,s){return{restrict:"E",link:function(o,t,r){var u=n(r.props)(),c=i.initLayoutContainer(t[0],u),l=function(){c.layout(),o.$emit("otLayoutComplete")};o.$watch(function(){return t.children().length},l),e.addEventListener("resize",l),o.$on("otLayout",l);var a=function(){s.session.on("streamPropertyChanged",function(e){"videoDimensions"===e.changedProperty&&l()})};return s.session?a():void s.on("init",a)}}}]).directive("otPublisher",["$rootScope","OTSession","OTDirectivesHelpers",function(e,n,i){function s(n){var i;["accessAllowed","accessDenied","accessDialogClosed","accessDialogOpened"].forEach(function(s){n.on(s,function(){("accessDenied"!==i||"accessDialogOpened"!==s)&&(i=s,e.$emit(s))})})}return{restrict:"E",scope:{props:"&"},link:function(e,o){var t=e.props()||{};t.width=t.width||o[0].offsetWidth,t.height=t.height||o[0].offsetHeight;var r=angular.element(o).children();e.publisher=n.initPublisher(o[0],t),angular.element(o).append(r),s(e.publisher),e.publisher.on("loaded",function(){e.publisher.on("audioLevelUpdated",i.setVolumeLevelChanges(o))}),e.$on("$destroy",function(){n.session?n.session.unpublish(e.publisher):e.publisher.destroy(),n.publishers=n.publishers.filter(function(n){return n!==e.publisher}),e.publisher=null}),n.isSessionConnected()?n.session.publish(e.publisher):e.publisher.on("streamDestroyed",function(e){e.preventDefault()}),n.publishers.push(e.publisher)}}}]).directive("otActiveCallerLayout",["_","OTDirectivesHelpers",function(e,n){return{restrict:"EA",link:function(i){var s=null,o=!0,t=e.debounce(function(){o=!0},500);i.$on("subscriber:volumeLevel",function(e,i,r){r!==n.volumeLevels[0].name&&(o&&i!==s?(s&&s.removeClass("ot-active"),s=i.addClass("ot-active"),o=!1):i===s&&t())})}}}]).directive("otSubscriber",["OTSession","OTDirectivesHelpers",function(e,n){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(i,s){s.addClass("ot-"+i.stream.videoType);var o=i.props()||{};o.width=o.width||s[0].offsetWidth,o.height=o.height||s[0].offsetHeight;var t=s.children(),r=e.session.subscribe(i.stream,s[0],o,function(e){e&&i.$emit("otSubscriberError",e,r)});r.on("loaded",function(){e.subscribers.push(r),i.$emit(i,"otLayout"),r.on("audioLevelUpdated",n.setVolumeLevelChanges(s,function(e){i.$emit("subscriber:volumeLevel",s,e)}))}),angular.element(s).append(t),i.$on("$destroy",function(){e.subscribers.splice(e.subscribers.indexOf(r),1),e.session&&e.session.unsubscribe(r)})}}}]);